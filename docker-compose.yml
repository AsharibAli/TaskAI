services:
  # ============================================
  # Infrastructure Services
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: taskai-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: taskai
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-taskai_secret}
      POSTGRES_DB: taskai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U taskai -d taskai"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - taskai-network

  # Kafka with KRaft mode (no Zookeeper required)
  kafka:
    image: bitnami/kafka:3.6
    container_name: taskai-kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      # KRaft settings
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # Auto-create topics
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      # Allow plaintext listener
      ALLOW_PLAINTEXT_LISTENER: "yes"
    volumes:
      - kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - taskai-network

  # Dapr Placement service
  dapr-placement:
    image: daprio/dapr:1.12.0
    container_name: taskai-dapr-placement
    command: ["./placement", "-port", "50006"]
    ports:
      - "50006:50006"
    networks:
      - taskai-network

  # ============================================
  # Application Services
  # ============================================
  backend:
    build: ./backend
    container_name: taskai-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://taskai:${POSTGRES_PASSWORD:-taskai_secret}@postgres:5432/taskai}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-min-32-chars}
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION_HOURS: 24
      CORS_ORIGINS: http://localhost:3000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4.1-2025-04-14}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-onboarding@resend.dev}
      FRONTEND_URL: http://localhost:3000
      DEBUG: ${DEBUG:-false}
      # Dapr configuration
      DAPR_ENABLED: "true"
      DAPR_HTTP_PORT: "3500"
      PUBSUB_NAME: "kafka-pubsub"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - taskai-network

  # Dapr sidecar for backend
  backend-dapr:
    image: daprio/daprd:1.12.0
    container_name: taskai-backend-dapr
    command: [
      "./daprd",
      "-app-id", "taskai-backend",
      "-app-port", "8000",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-placement-host-address", "dapr-placement:50006",
      "-resources-path", "/components"
    ]
    volumes:
      - ./dapr/components:/components
    depends_on:
      - backend
      - dapr-placement
      - kafka
    network_mode: "service:backend"

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8000
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID:-}
    container_name: taskai-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
    depends_on:
      - backend
    networks:
      - taskai-network

  # ============================================
  # Microservices
  # ============================================
  notification-service:
    build: ./notification-service
    container_name: taskai-notification-service
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      APP_NAME: taskai-notification-service
      APP_VERSION: "1.0.0"
      LOG_LEVEL: DEBUG
      LOG_FORMAT: json
      PUBSUB_NAME: kafka-pubsub
      DAPR_HTTP_PORT: "3500"
    depends_on:
      - kafka
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - taskai-network

  # Dapr sidecar for notification-service
  notification-service-dapr:
    image: daprio/daprd:1.12.0
    container_name: taskai-notification-service-dapr
    command: [
      "./daprd",
      "-app-id", "taskai-notification-service",
      "-app-port", "8001",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-placement-host-address", "dapr-placement:50006",
      "-resources-path", "/components"
    ]
    volumes:
      - ./dapr/components:/components
    depends_on:
      - notification-service
      - dapr-placement
      - kafka
    network_mode: "service:notification-service"

  recurring-service:
    build: ./recurring-service
    container_name: taskai-recurring-service
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      APP_NAME: taskai-recurring-service
      APP_VERSION: "1.0.0"
      LOG_LEVEL: DEBUG
      LOG_FORMAT: json
      PUBSUB_NAME: kafka-pubsub
      DAPR_HTTP_PORT: "3500"
      BACKEND_URL: http://backend:8000
    depends_on:
      - kafka
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - taskai-network

  # Dapr sidecar for recurring-service
  recurring-service-dapr:
    image: daprio/daprd:1.12.0
    container_name: taskai-recurring-service-dapr
    command: [
      "./daprd",
      "-app-id", "taskai-recurring-service",
      "-app-port", "8002",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-placement-host-address", "dapr-placement:50006",
      "-resources-path", "/components"
    ]
    volumes:
      - ./dapr/components:/components
    depends_on:
      - recurring-service
      - dapr-placement
      - kafka
    network_mode: "service:recurring-service"

volumes:
  postgres_data:
  kafka_data:

networks:
  taskai-network:
    driver: bridge
